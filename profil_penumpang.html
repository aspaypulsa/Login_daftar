<script>
    // Data pengguna
    let userData = {
        phone: "",
        photoFile: null,
        photoUrl: ""
    };
    
    // Elemen DOM
    const phoneInput = document.getElementById('phone');
    const fileInput = document.getElementById('fileInput');
    const uploadTrigger = document.getElementById('uploadTrigger');
    const photoPreview = document.getElementById('photoPreview');
    const previewImage = document.getElementById('previewImage'); // Diperbaiki dari 'previewImage'
    const saveBtn = document.getElementById('saveBtn');
    const profileForm = document.getElementById('profileForm');
    
    // Parse parameter URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialPhone = urlParams.get('phone');
    const imgbbKey = urlParams.get('imgbbKey');

    // Fungsi untuk mengirim data ke App Inventor
    function sendToAppInventor(data) {
        try {
            // Method 1: Untuk WebView App Inventor modern
            if (window.app && window.app.inventor) {
                window.app.inventor.webstring = JSON.stringify(data);
                return;
            }
            
            // Method 2: Untuk Android
            if (window.Android) {
                window.Android.receiveFromWeb(JSON.stringify(data));
                return;
            }
            
            // Method 3: Untuk iOS
            if (window.webkit && window.webkit.messageHandlers) {
                window.webkit.messageHandlers.iosHandler.postMessage(data);
                return;
            }
            
            console.log("Data untuk App Inventor:", data);
        } catch (error) {
            console.error("Gagal mengirim data ke App Inventor:", error);
        }
    }

    // Isi nilai awal jika ada di URL
    if (initialPhone) {
        phoneInput.value = initialPhone.replace(/\D/g, ''); // Hanya angka
        userData.phone = initialPhone;
    }

    // Event listener untuk upload foto
    uploadTrigger.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validasi
        if (!file.type.match('image.*')) {
            alert('Hanya file gambar yang diizinkan');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('Ukuran file maksimal 5MB');
            return;
        }

        // Preview gambar
        const reader = new FileReader();
        reader.onload = (event) => {
            previewImage.src = event.target.result;
            previewImage.style.display = 'block';
            photoPreview.querySelector('i').style.display = 'none';
        };
        reader.readAsDataURL(file);
        
        userData.photoFile = file;
    });

    // Format input nomor HP
    phoneInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
        if (this.value.length > 15) {
            this.value = this.value.slice(0, 15);
        }
    });

    // Submit form
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validasi
        userData.phone = phoneInput.value.trim();
        if (!userData.phone) {
            alert('Harap isi nomor HP');
            return;
        }

        if (!userData.photoFile) {
            alert('Harap pilih foto profil');
            return;
        }

        if (!imgbbKey) {
            const errorMsg = "API Key imgBB tidak ditemukan";
            sendToAppInventor({
                status: "error",
                message: errorMsg
            });
            alert(errorMsg);
            return;
        }

        // Upload foto
        try {
            const formData = new FormData();
            formData.append('image', userData.photoFile);
            formData.append('key', imgbbKey);

            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error?.message || 'Upload gagal');
            }

            userData.photoUrl = result.data.url;

            // Kirim data ke App Inventor
            sendToAppInventor({
                status: "success",
                phone: userData.phone,
                photoUrl: userData.photoUrl
            });

            alert('Profil berhasil disimpan!');

        } catch (error) {
            console.error('Error:', error);
            sendToAppInventor({
                status: "error",
                message: error.message
            });
            alert('Gagal menyimpan: ' + error.message);
        }
    });

    // Fungsi bantuan untuk debug
    window.debugData = () => {
        console.log("Data saat ini:", userData);
        return userData;
    };
</script>
