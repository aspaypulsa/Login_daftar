<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Penumpang - Kodular Fix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [CSS TIDAK BERUBAH, SAMA PERSIS DENGAN SEBELUMNYA] */
        /* ... (copy semua style yang ada sebelumnya) ... */
    </style>
</head>
<body>
    <!-- [HTML TIDAK BERUBAH] -->
    <!-- ... (copy semua HTML yang ada sebelumnya) ... -->

    <script>
        // Data pengguna
        let userData = {
            phone: "",
            photoFile: null,
            photoUrl: ""
        };
        
        // Elemen DOM
        const phoneInput = document.getElementById('phone');
        const fileInput = document.getElementById('fileInput');
        const uploadTrigger = document.getElementById('uploadTrigger');
        const photoPreview = document.getElementById('photoPreview');
        const previewImage = document.getElementById('previewImage');
        const saveBtn = document.getElementById('saveBtn');
        const profileForm = document.getElementById('profileForm');
        
        // Parse parameter URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialPhone = urlParams.get('phone');
        const imgbbKey = urlParams.get('imgbbKey');

        // =============================================
        // FUNGSI UTAMA UNTUK KODULAR WEBVIEW
        // =============================================

        // 1. Fungsi untuk mengirim data ke App Inventor/Kodular
        function sendToAppInventor(data) {
            console.log("Mengirim data:", data);
            
            // Method 1: Untuk Kodular WebView
            if (window.AppInventor && window.AppInventor.setWebViewString) {
                try {
                    window.AppInventor.setWebViewString(JSON.stringify(data));
                    console.log("Data terkirim via Kodular WebView");
                    return true;
                } catch (e) {
                    console.error("Gagal mengirim via Kodular:", e);
                }
            }
            
            // Method 2: Untuk debugging di browser
            console.log("Data untuk App Inventor (browser):", data);
            alert("Data akan dikirim: " + JSON.stringify(data));
            return false;
        }

        // 2. Fungsi untuk menerima file dari Kodular (jika ada)
        window.receiveFileFromApp = function(base64Data, fileName) {
            try {
                console.log("Menerima file dari Kodular:", fileName);
                
                // Konversi base64 ke File object
                const mimeType = "image/jpeg"; // Sesuaikan jika perlu
                const file = base64ToFile(base64Data, fileName, mimeType);
                userData.photoFile = file;
                
                // Tampilkan preview
                previewImage.src = URL.createObjectURL(file);
                previewImage.style.display = 'block';
                photoPreview.querySelector('i').style.display = 'none';
                
                return true;
            } catch (e) {
                console.error("Gagal memproses file:", e);
                return false;
            }
        };

        // 3. Handler untuk upload foto (Kodular + fallback browser)
        uploadTrigger.addEventListener('click', function() {
            console.log("Tombol upload diklik");
            
            // Coba deteksi Kodular WebView
            if (window.AppInventor && window.AppInventor.requestFilePicker) {
                console.log("Memanggil file picker Kodular");
                window.AppInventor.requestFilePicker();
            } else {
                console.log("Menggunakan input file standar");
                fileInput.click();
            }
        });

        // 4. Helper: Konversi base64 ke File
        function base64ToFile(base64, filename, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            return new File([byteArray], filename, {type: mimeType});
        }

        // =============================================
        // FUNGSI TAMBAHAN (SAMA SEBELUMNYA)
        // =============================================

        // Isi nilai awal jika ada di URL
        if (initialPhone) {
            phoneInput.value = initialPhone.replace(/\D/g, '');
            userData.phone = initialPhone;
        }

        // Handler untuk input file standar (browser)
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            console.log("File dipilih via input standar:", file.name);

            // Validasi
            if (!file.type.match('image.*')) {
                alert('Hanya file gambar yang diizinkan (JPEG, PNG)');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file maksimal 5MB');
                return;
            }

            // Simpan file
            userData.photoFile = file;
            
            // Tampilkan preview
            previewImage.src = URL.createObjectURL(file);
            previewImage.style.display = 'block';
            photoPreview.querySelector('i').style.display = 'none';
        });

        // Format input nomor HP
        phoneInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length > 15) {
                this.value = this.value.slice(0, 15);
            }
            userData.phone = this.value;
        });

        // Submit form
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("Form disubmit");
            
            // Validasi
            userData.phone = phoneInput.value.trim();
            if (!userData.phone) {
                alert('Harap isi nomor HP');
                return;
            }

            if (!userData.photoFile) {
                alert('Harap pilih foto profil');
                return;
            }

            if (!imgbbKey) {
                const errorMsg = "API Key imgBB tidak ditemukan";
                sendToAppInventor({
                    status: "error",
                    message: errorMsg
                });
                alert(errorMsg);
                return;
            }

            // Tampilkan loading
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                // Upload foto ke imgBB
                const formData = new FormData();
                formData.append('image', userData.photoFile);
                formData.append('key', imgbbKey);

                console.log("Mengupload foto ke imgBB...");
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log("Hasil upload:", result);

                if (!result.success) {
                    throw new Error(result.error?.message || 'Upload foto gagal');
                }

                userData.photoUrl = result.data.url;
                console.log("Foto berhasil diupload:", userData.photoUrl);

                // Kirim data ke App Inventor
                const dataToSend = {
                    status: "success",
                    phone: userData.phone,
                    photoUrl: userData.photoUrl,
                    timestamp: new Date().toISOString()
                };

                if (!sendToAppInventor(dataToSend)) {
                    throw new Error("Gagal mengirim data ke App Inventor");
                }

                alert('Profil berhasil disimpan!\nNomor: ' + userData.phone);

            } catch (error) {
                console.error('Error:', error);
                sendToAppInventor({
                    status: "error",
                    message: error.message,
                    phone: userData.phone || ""
                });
                alert('Gagal menyimpan: ' + error.message);
            } finally {
                // Reset tombol
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Profil';
            }
        });

        // =============================================
        // FUNGSI UNTUK TESTING KODULAR
        // =============================================

        // Fungsi untuk mengecek koneksi ke Kodular
        function checkAppInventorConnection() {
            if (window.AppInventor) {
                console.log("Terkoneksi dengan Kodular WebView");
                return true;
            } else {
                console.log("Tidak terdeteksi Kodular WebView");
                return false;
            }
        }

        // Jalankan pengecekan saat halaman dimuat
        window.addEventListener('load', function() {
            const isKodular = checkAppInventorConnection();
            console.log("Status Kodular:", isKodular);
            
            // Jika di Kodular, tampilkan notifikasi
            if (isKodular) {
                console.log("Menggunakan environment Kodular");
            } else {
                console.log("Menggunakan browser biasa");
            }
        });
    </script>
</body>
</html>
